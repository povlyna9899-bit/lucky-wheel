<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Lucky wheel SB24 Chines new year</title>
<link rel="icon" href="favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>

body{
  margin:0;
  font-family:'Segoe UI', sans-serif;
  min-height:100vh;
  color:white;
  overflow-x:hidden;

  background:
    linear-gradient(rgba(0,0,0,0.65), rgba(0,0,0,0.75)),
    url("img/bg.jpg");   /* üëâ ·ûä·û∂·ûÄ·üã path ·ûö·ûº·ûî·ûë·û∏·ûì·üÅ·üá */

  background-size:cover;
  background-position:center;
  background-attachment:fixed;
}
/* Spark gold background */
body::before{
  content:"";
  position:fixed;
  inset:0;
  background:
    radial-gradient(circle at center, rgba(255,80,0,0.35), transparent 60%),
    radial-gradient(circle at 30% 40%, rgba(255,140,0,0.25), transparent 70%);
  filter:blur(120px);
  z-index:-1;
}
.firework{
  position:fixed;
  width:6px;
  height:6px;
  border-radius:50%;
  pointer-events:none;
  z-index:99999;
  animation: explode 1s ease-out forwards;
}

@keyframes explode{
  0%{
    transform:scale(0.3);
    opacity:1;
  }
  100%{
    transform:scale(4);
    opacity:0;
  }
}
#fireworksContainer{
  position:fixed;
  inset:0;
  pointer-events:none;
  z-index:999999; /* ·ûõ·ûæ·ûÇ·üÅ */
}

.firework{
  position:absolute;
  width:6px;
  height:6px;
  border-radius:50%;
}

/* TOP BAR */
.topbar{
  position:relative;
  width:100%;
  height:80px;
  background:linear-gradient(to right,#000000,#1a1a1a);
  border-bottom:1px solid gold;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 20px;
  box-sizing:border-box;
  border-bottom:1px solid rgba(255,215,0,0.3);
  background:#000;
  border-bottom:1px solid rgba(255,215,0,0.3);
}
.menu-btn{
  font-size:28px;
  cursor:pointer;
  padding:10px 18px;
  border-radius:12px;

  background:linear-gradient(145deg,#ffd700,#ff9900);
  color:black;
  font-weight:bold;

  box-shadow:0 0 15px rgba(255,215,0,0.6);
  transition:0.3s;
}

.menu-btn:hover{
  transform:scale(1.15);
  box-shadow:0 0 25px rgba(255,215,0,1);
}

/* CENTER TITLE */
.nav-center{
  position:absolute;
  left:50%;
  transform:translateX(-50%);
  font-weight:bold;
  font-size:16px;
  color:white;
  letter-spacing:1px;
}

/* RIGHT SIDE */
.nav-right{
  display:flex;
  align-items:center;
  gap:10px;
}

/* USER BOX */
.user-box{
  color:#00ffcc;
  font-weight:bold;
  font-size:18px;
}

/* SPIN BOX */
.spin-box{
  background:linear-gradient(45deg,#ffd700,#ff9900);
  padding:12px 25px;
  border-radius:50px;
  font-size:18px;
  font-weight:bold;
  color:black;

  box-shadow:0 0 20px rgba(255,215,0,0.7);

  animation:pulse 1.5s infinite;
}
.spin-box.stop{
  animation:none;
  opacity:0.6;
  transform:scale(1);
  box-shadow:0 0 10px rgba(255,215,0,0.3);
}



/* SIDEBAR */
.sidebar{
  position:fixed;
  left:-220px;
  top:0;
  width:220px;
  height:100%;
  background: rgba(0,0,0,0.9);
  transition:0.3s;
  padding-top:70px;
  box-shadow:5px 0 20px rgba(0,0,0,0.5);
}

.sidebar a{
  display:block;
  padding:18px 25px;
  font-size:20px;      /* üî• ·ûí·üÜ·ûá·û∂·ûÑ·ûò·ûª·ûì */
  font-weight:600;
  letter-spacing:1px;

  color:#fff;
  text-decoration:none;

  border-bottom:1px solid rgba(255,255,255,0.08);
  transition:0.3s;
}


.sidebar a:hover{
  background:gold;
  color:rgb(255, 0, 0);
}

.sidebar.active{
  left:0;
}

/* CONTENT */
.content{
  text-align:center;
  padding:40px 20px;
}

/* CARD STYLE & WHEEL area */
#wheelContainer{
  width:fit-content;
  margin:40px auto;
  padding:25px;
  border-radius:70px;
  position:relative;
 background:linear-gradient(145deg,#8b0000,#3b0000);
  border:2px solid gold;
  box-shadow:0 0 30px rgba(255,215,0,0.4);
}


/* wrapper for pointer + canvas */
#wheelWrapper{
  position:relative;
  width:90vw;          /* üî• 90% ·ûë·ûë·ûπ·ûÑ·û¢·üÅ·ûÄ·üí·ûö·ûÑ·üã */
  left:-3%;
  max-width:500px;     /* ·ûÄ·ûª·üÜ·û¢·üÑ·ûô·ûí·üÜ·ûñ·üÅ·ûÄ·ûõ·ûæ PC */
  aspect-ratio:1/1;
  margin:auto;
}

.pointer{
  position:absolute;
  top:-1px;
  left:53%;
  transform:translateX(-50%) rotate(180deg);
  width:0;
  height:0;
  border-left:18px solid transparent;
  border-right:18px solid transparent;
  border-bottom:25px solid red;
  filter: drop-shadow(0 0 12px #ff0000);
  z-index: 9999;             /* üî• ·ûü·üÜ·ûÅ·û∂·ûì·üã */
}
canvas{
  width:100%;
  height:100%;
  border-radius:50%;
  border:16px solid gold;
   box-shadow:
    0 0 30px #ffae00,
    0 0 60px #ff3c00,
    0 0 120px rgba(255,80,0,0.8);
  background: radial-gradient(circle, #111 0%, #000 100%);
}

button{
  margin-top:35px;
  padding:18px 60px;
  font-size:20px;
  font-weight:bold;
  border-radius:40px;
  border:none;

  background:linear-gradient(45deg,#ffd700,#ffb300);
  color:#000;

  box-shadow:0 0 20px rgba(255,215,0,0.6);
  transition:0.3s;
}

button:hover{
  transform:scale(1.08);
  box-shadow:0 0 30px rgba(255,215,0,1);
}
.card{
  background:#111;
  border-radius:20px;
  border:1px solid rgba(255,215,0,0.15);
  box-shadow:0 15px 50px rgba(0,0,0,0.7);
}


/* RESULT */
#result{
  margin-top:25px;
  font-size:24px;
  font-weight:bold;
  animation: glow 1s infinite alternate;
}

@keyframes glow{
  from{ text-shadow:0 0 5px lime; }
  to{ text-shadow:0 0 20px rgb(0, 255, 64); }
}

/* üé¨ AUTO SLIDER */
.slider{
  width:90%;
  max-width:600px;
  height:260px;
  margin:60px auto;
  overflow:hidden;
  border-radius:20px;
  box-shadow:0 0 35px rgb(0, 0, 0);
}

.slides{
  display:flex;
  width:300%;
  animation: slide 20s infinite;
}

.slides img{
  width:100%;
  height:260px;
  object-fit:contain;
  background:#000;
}

@keyframes slide{
  0%   { transform:translateX(0); }
  33%  { transform:translateX(-100%); }
  66%  { transform:translateX(-200%); }
  100% { transform:translateX(0); }
}
@keyframes pulse{
  0%{
    transform:scale(1);
    box-shadow:0 0 10px rgba(255,215,0,0.6);
  }
  50%{
    transform:scale(1.15);
    box-shadow:0 0 30px rgba(255,215,0,1);
  }
  100%{
    transform:scale(1);
    box-shadow:0 0 10px rgba(255,215,0,0.6);
  }
}

/* MUSIC BUTTON */
.music-btn{
  position:fixed;
  bottom:25px;
  right:25px;
  padding:12px 20px;
  border:none;
  border-radius:30px;
  font-size:14px;
  font-weight:bold;
  cursor:pointer;
  background:linear-gradient(45deg,#ffd700,#ff9900);
  color:black;
  box-shadow:0 0 15px #ffd700;
  transition:0.3s;
  z-index:999;
}

.music-btn:hover{
  transform:scale(1.08);
  box-shadow:0 0 25px #ffd700;
}

.music-off{
  background:linear-gradient(45deg,#555,#222);
  color:white;
  box-shadow:0 0 15px #999;
}
@media (max-width:600px){
  button{
    width:85%;
    font-size:20px;
    padding:18px 0;
  }
}
.social-buttons{
    margin-top:100px;
    display:flex;
    justify-content:center;
    align-items:center;
    gap:15px;
    flex-wrap:wrap; /* ·ûü·ûò·üí·ûö·û∂·ûî·üã mobile */
}


.social-btn{
  margin-right:8px;
  font-size:18px;
  width:250px;
  padding:12px;
  text-align:center;
  border-radius:30px;
  font-weight:bold;
  text-decoration:none;
  color:white;
  transition:0.3s;
  box-shadow:0 0 10px rgba(255,140,0,0.6);
}

.telegram{
  background:#0088cc;
}

.facebook{
  background:#1877f2;
}

.channel{
  background:#ff8c00;
}

.social-btn:hover{
  transform:scale(1.05);
  box-shadow:0 0 20px orange;
}
</style>
</head>
<body>
<div id="fireworksContainer"></div>
<script>
/* üîê Protect Page */
const token = localStorage.getItem("playerToken");
if(!token){
  window.location.href="/player-login.html";
}
</script>

<!-- TOP BAR -->
<div class="topbar">

  <!-- LEFT -->
  <div class="nav-left">
    <div class="menu-btn" onclick="toggleMenu()">‚ò∞</div>
  </div>

  <!-- CENTER LOGO -->
  <div class="nav-center">
    üßß <span>Lucky wheel SB24 Chines new yea</span>
  </div>

  <!-- RIGHT USER AREA -->
  <div class="nav-right">
    <div class="user-box">
      üë§ <span id="username"></span>
    </div>

    <div class="spin-box">
      üéØ <span id="topSpins">0</span>
    </div>
  </div>
</div>

<!-- SIDEBAR -->
<div class="sidebar" id="sidebar">
  <a href="#" onclick="showGame(); closeMenu()">üé° Spin Game</a>
  <a href="#" onclick="showHistory(); closeMenu()">üìú My History</a>
  <a href="#" onclick="logout()">üö™ Logout</a>
</div>


<!-- CONTENT -->
<div class="content">

  <!-- game -->
  <div id="gameSection">
    <h2>Spin & Win</h2>

    <!-- wheel -->
    <div id="wheelContainer">
      <div id="wheelWrapper">
        <div class="pointer"></div>
        <canvas id="wheelCanvas" width="420" height="420"></canvas>
      </div>
    </div>
     
    <button onclick="spinWheel()">üé° SPIN</button>
    <div id="result"></div>
  </div>

  <!-- history -->
  <div id="historySection" style="display:none;">
    <h2>My Spin History</h2>
    <div id="historyData">Loading...</div>
  </div>

  <!-- slider -->
  <div class="slider">
    <div class="slides">
      <img src="img/poster1.jpg" alt="Poster 1">
      <img src="img/poster2.jpg" alt="Poster 2">
      <img src="img/poster3.jpg" alt="Poster 3">
    </div>
  </div>
  <div class="social-buttons">
   <a href="#" class="social-btn telegram">
      <i class="fab fa-telegram"></i> Telegram Support
   </a>

   <a href="#" class="social-btn facebook">
      <i class="fab fa-facebook"></i> Facebook Page
   </a>

   <a href="#" class="social-btn channel">
      <i class="fab fa-telegram"></i> Telegram Channel
   </a>
</div>
</div>

<!-- Music -->
<audio id="casinoMusic" loop autoplay muted>
  <source src="/music.mp3" type="audio/mpeg">
</audio>

<button id="musicToggle" class="music-btn">
  üîä MUSIC ON
</button>

<script>
  //---------spin stop-----------//
  function checkSpinAnimation(spins){
  const spinBox = document.querySelector(".spin-box");

  if(spins <= 0){
    spinBox.classList.add("stop");
  }else{
    spinBox.classList.remove("stop");
  }
}

// ----- parse token to get username -----
function parseJwt(token){
  return JSON.parse(atob(token.split('.')[1]));
}
const decoded = parseJwt(token);
document.getElementById("username").innerText = decoded.username;

// ----- MENU / LOGOUT / SECTION -----
function toggleMenu(){
  const sidebar = document.getElementById("sidebar");
  sidebar.classList.toggle("active");
}

function logout(){
  // keep musicState if you want, but remove token only
  localStorage.removeItem("playerToken");
  window.location.href="/player-login.html";
}

function showGame(){
  document.getElementById("gameSection").style.display="block";
  document.getElementById("historySection").style.display="none";
}

function showHistory(){
  document.getElementById("gameSection").style.display="none";
  document.getElementById("historySection").style.display="block";
  loadHistory();
}
function closeMenu(){
  document.getElementById("sidebar").classList.remove("active");
}

// Close sidebar when clicking outside
document.addEventListener("click", function(e){
  const sidebar = document.getElementById("sidebar");
  const menuBtn = document.querySelector(".menu-btn");

  if(
    sidebar.classList.contains("active") &&
    !sidebar.contains(e.target) &&
    !menuBtn.contains(e.target)
  ){
    sidebar.classList.remove("active");
  }
});
/* ------------------------------------ */
/* --------- Draw wheel style ---------- */
/* ------------------------------------ */

const canvas = document.getElementById("wheelCanvas");
const ctx = canvas.getContext("2d");

/* üî• ·ûä·û∂·ûÄ·üã prizes ·ûõ·ûæ·ûÇ·üÅ·ûî·üÜ·ûï·ûª·ûè */
const prizes = [
  { value: 0,  label: "0$" },
  { value: 5,  label: "5$" },
  { value: 10, label: "10$" },
  { value: 20, label: "20$" },
  { value: 30, label: "30$" },
  { value: 50, label: "50$" },
  { value: 100,label: "100$" },
  { value: 200,label: "200$" }
];

let currentRotation = 0;
let spinning = false;

/* ·ûî·ûì·üí·ûë·û∂·ûî·üã·ûò·ûÄ·ûë·ûæ·ûî·ûò·û∂·ûì function drawWheel */
function drawWheel(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const arc = 2*Math.PI/prizes.length;
  ctx.font = "bold 14px Segoe UI";
  ctx.textAlign = "right";

  for(let i=0;i<prizes.length;i++){
    ctx.beginPath();
    ctx.moveTo(canvas.width/2,canvas.height/2);

    ctx.fillStyle = (i % 2 === 0) ? "#ffd700" : "#1a1a1a";

    ctx.arc(
      canvas.width/2,
      canvas.height/2,
      canvas.width/2,
      i * arc - Math.PI/2,
      (i + 1) * arc - Math.PI/2
    );

    ctx.fill();

    ctx.save();
    ctx.translate(canvas.width/2,canvas.height/2);
    ctx.rotate(i*arc + arc/2 - Math.PI/2);
    ctx.fillStyle = (i % 2 === 0) ? "#000" : "#ffd700";
    ctx.fillText(prizes[i].label,canvas.width/2 - 20,10);
    ctx.restore();
  }
}

drawWheel();


/* ------------------------------------ */
/* --------- Spin logic -------------- */
/* ------------------------------------ */

async function spinWheel(){
  if(spinning) return;

  const res = await fetch("/spin",{
    method:"POST",
    headers:{ "Authorization":"Bearer "+token }
  });

  const data = await res.json();

  console.log("Server prize:", data.prize, typeof data.prize); // debug

  if(!res.ok){
    alert(data.message);
    return;
  }

  spinning = true;

  // ·ûÄ·üÜ·ûé·ûè·üã index
  let index = -1;

  // ·ûî·üí·ûö·ûü·û∑·ûì·ûî·ûæ prize ·ûá·û∂ number
  if(typeof data.prize === "number"){
    index = prizes.findIndex(p => p.value === data.prize);
  } else {
    // ·ûî·üí·ûö·ûü·û∑·ûì·ûî·ûæ prize ·ûá·û∂ string
    // ·û¢·û∂·ûÖ·ûò·û∂·ûì "50$" ·û¨‚Äã ·û¨ "Try Again"
    // ·ûá·û∂·ûò·ûΩ·ûô label ·û¨ value
    index = prizes.findIndex(p => p.label === data.prize);
    // ·ûî·ûæ·ûè·üí·ûö·ûº·ûú·ûè·üÇ·ûä·ûÄ $ ·û≤·üí·ûô·ûî·üí·ûö·üÄ·ûî·ûî·üí·ûö·ûä·û∂·ûî·üã
    if(index < 0){
      // try to parse number from string
      const num = parseInt(data.prize.replace(/[^0-9]/g, ""));
      if(!isNaN(num)){
        index = prizes.findIndex(p => p.value === num);
      }
    }
  }

  if(index < 0){
    // fallback
    index = 0;
  }

const sliceDeg = 360 / prizes.length;

// ·ûÇ·ûé·ûì·û∂ degree ·ûÖ·ûª·ûÑ·ûÄ·üí·ûö·üÑ·ûô·ûè·üí·ûö·ûπ·ûò·ûè·üí·ûö·ûº·ûú
const finalDeg = 360 - (index * sliceDeg) - sliceDeg / 2;

// ·ûî·ûÑ·üí·ûú·û∑·ûõ 5 ·ûá·ûª·üÜ ·û†·ûæ·ûô·ûî·ûâ·üí·ûà·ûî·üã·ûè·üí·ûö·ûπ·ûò slice
const totalRotation = 360 * 5 + finalDeg;

// RESET rotation ·ûò·ûª·ûì
canvas.style.transition = "none";
canvas.style.transform = "rotate(0deg)";

// ·ûî·ûÑ·üí·ûÅ·üÜ browser reflow
void canvas.offsetWidth;

// ·ûî·ûÑ·üí·ûú·û∑·ûõ·ûê·üí·ûò·û∏
canvas.style.transition = "transform 6s cubic-bezier(.15,.85,.25,1)"
canvas.style.transform = `rotate(${totalRotation}deg)`;


 setTimeout(()=>{

  document.getElementById("result").innerText =
    "üéâ  ·û¢·üí·ûì·ûÄ·ûà·üí·ûì·üá: "+data.prize+
    " | Remaining Spins: "+data.spinsLeft;

  document.getElementById("topSpins").innerText = data.spinsLeft;
  checkSpinAnimation(data.spinsLeft);

  createFirework();
  createFirework();
  createFirework();

  spinning = false;

},6000);

}

/* ------------------------------------ */
/* --------- History ------------------ */
/* ------------------------------------ */
async function loadHistory(){
  const res = await fetch("/api/history",{
    headers:{ "Authorization":"Bearer "+token }
  });

  const data = await res.json();

  if(!data.length){
    document.getElementById("historyData").innerHTML="No spins yet.";
    return;
  }

  let html="";
  data.forEach(d=>{
    html += `
      <div style="padding:10px;border-bottom:1px solid #444;">
        üéÅ $${d.prize}<br>
        üìÖ ${new Date(d.createdAt).toLocaleString()}
      </div>
    `;
  });
  document.getElementById("historyData").innerHTML=html;
}

/* ------------------------------------ */
/* --------- Load balance on start ---- */
/* ------------------------------------ */
async function loadMySpin(){
  const res = await fetch("/api/my-spin",{
    headers:{ "Authorization":"Bearer "+token }
  });
  const data = await res.json();

  document.getElementById("topSpins").innerText = data.spinsLeft;
}
loadMySpin();

/* ------------------------------------ */
/* --------- Music toggle ------------ */
/* ------------------------------------ */
document.addEventListener("DOMContentLoaded", function () {
  const musicBtn = document.getElementById("musicToggle");
  const casinoMusic = document.getElementById("casinoMusic");

  // Read from localStorage (data saved across sessions).  
  // localStorage persists across browser sessions according to MDN docs. :contentReference[oaicite:0]{index=0}
  let state = localStorage.getItem("musicState") || "on";

  function updateMusic(){
    if(state === "on"){
      casinoMusic.muted = false;
      musicBtn.innerText = "üîä MUSIC ON";
      casinoMusic.play().catch(()=>{});
    } else {
      casinoMusic.muted = true;
      musicBtn.innerText = "üîá MUSIC OFF";
    }
  }

  updateMusic();

  musicBtn.addEventListener("click", ()=>{
    state = (state === "on") ? "off" : "on";
    localStorage.setItem("musicState", state);
    updateMusic();
  });

});
function createFirework(){

  const container = document.getElementById("fireworksContainer");

  const x = Math.random() * window.innerWidth;
  const y = Math.random() * window.innerHeight * 0.6;

  for(let i=0;i<35;i++){

    const particle = document.createElement("div");
    particle.className = "firework";

    const angle = Math.random() * 2 * Math.PI;
    const distance = Math.random() * 150;

    const dx = Math.cos(angle) * distance;
    const dy = Math.sin(angle) * distance;

    particle.style.left = x + "px";
    particle.style.top = y + "px";
    particle.style.background =
      `hsl(${Math.random()*360},100%,60%)`;

    particle.animate([
      { transform: "translate(0,0)", opacity:1 },
      { transform: `translate(${dx}px,${dy}px)`, opacity:0 }
    ],{
      duration:1200,
      easing:"ease-out"
    });

    container.appendChild(particle);

    setTimeout(()=>{
      particle.remove();
    },1200);
  }
}

</script>

</body>
</html>
