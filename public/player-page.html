<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Player Dashboard</title>
<link rel="icon" href="favicon.ico" type="image/x-icon">

<style>
body{
  margin:0;
  font-family:'Segoe UI', sans-serif;
  min-height:100vh;
  color:white;
  overflow-x:hidden;

  background:
    radial-gradient(circle at 50% 30%, rgba(255,215,0,0.12), transparent 60%),
    linear-gradient(to bottom, #000000, #0a0a0a 50%, #000000);

  background-attachment: fixed;
}
/* Spark gold background */
body::before{
  content:"";
  position:fixed;
  inset:0;
  background:
    radial-gradient(circle at center, rgba(255,180,0,0.35), transparent 60%),
    radial-gradient(circle at 30% 40%, rgba(255,140,0,0.25), transparent 70%),
    radial-gradient(circle at 70% 60%, rgba(255,200,0,0.2), transparent 70%);
  filter:blur(120px);
  z-index:-1;
}

/* TOP BAR */
.topbar{
  position:relative;
  width:100%;
  height:80px;
  background:linear-gradient(to right,#000000,#1a1a1a);
  border-bottom:1px solid gold;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 20px;
  box-sizing:border-box;
  border-bottom:1px solid rgba(255,215,0,0.3);
  background:#000;
  border-bottom:1px solid rgba(255,215,0,0.3);
}

/* CENTER TITLE */
.nav-center{
  position:absolute;
  left:50%;
  transform:translateX(-50%);
  font-weight:bold;
  font-size:16px;
  color:white;
  letter-spacing:1px;
}

/* RIGHT SIDE */
.nav-right{
  display:flex;
  align-items:center;
  gap:10px;
}

/* USER BOX */
.user-box{
  color:#00ffcc;
  font-weight:bold;
  font-size:18px;
}

/* SPIN BOX */
.spin-box{
  background:linear-gradient(45deg,#ffd700,#ff9900);
  padding:10px 18px;
  border-radius:50px;
  font-size:16px;
  font-weight:bold;
  color:black;
  box-shadow:0 0 12px #ffd700;
  animation:spinGlow 1.5s infinite alternate;
}

@keyframes spinGlow{
  from{ box-shadow:0 0 5px #ffd700; }
  to{ box-shadow:0 0 20px #ffd700; }
}

/* SIDEBAR */
.sidebar{
  position:fixed;
  left:-220px;
  top:0;
  width:220px;
  height:100%;
  background: rgba(0,0,0,0.9);
  transition:0.3s;
  padding-top:70px;
  box-shadow:5px 0 20px rgba(0,0,0,0.5);
}

.sidebar a{
  display:block;
  padding:15px 20px;
  color:white;
  text-decoration:none;
  border-bottom:1px solid rgba(255,255,255,0.05);
  transition:0.3s;
}

.sidebar a:hover{
  background:gold;
  color:rgb(255, 0, 0);
}

.sidebar.active{
  left:0;
}

/* CONTENT */
.content{
  text-align:center;
  padding:40px 20px;
}

/* CARD STYLE & WHEEL area */
#wheelContainer{
  width:fit-content;
  margin:40px auto;
  padding:25px;
  border-radius:70px;

  background:#111;
  border:1px solid rgba(255,225,0,0.3);

  box-shadow:
    0 0 40px rgba(255,225,0,0.3),
    0 20px 60px rgba(0,0,0,0.8);
}

/* wrapper for pointer + canvas */
#wheelWrapper{
  position:relative;
  width:90vw;          /* ğŸ”¥ 90% á‘á‘á¹á„á¢áŸá€áŸ’ášá„áŸ‹ */
  left:-3%;
  max-width:500px;     /* á€á»áŸ†á¢áŸ„á™á’áŸ†á–áŸá€á›á¾ PC */
  aspect-ratio:1/1;
  margin:auto;
}

.pointer{
  position:absolute;
  top:-1px;
  left:53%;
  transform:translateX(-50%) rotate(180deg);
  width:0;
  height:0;
  border-left:18px solid transparent;
  border-right:18px solid transparent;
  border-bottom:25px solid red;

  z-index: 9999;             /* ğŸ”¥ áŸáŸ†áá¶á“áŸ‹ */
}
canvas{
  width:100%;
  height:100%;
  border-radius:50%;
  border:16px solid gold;
  box-shadow:0 0 40px rgba(255,215,0,0.6);
  background: radial-gradient(circle, #111 0%, #000 100%);
}

button{
  margin-top:35px;
  padding:18px 60px;
  font-size:22px;
  font-weight:bold;
  letter-spacing:1px;

  background: linear-gradient(145deg,#ffd700,#ffb300);
  color:#000;

  border:none;
  border-radius:50px;
  cursor:pointer;

  box-shadow:
    0 8px 25px rgba(255,215,0,0.5),
    inset 0 2px 8px rgba(255,255,255,0.6);

  transition: all 0.3s ease;
}

button:hover{
  transform:scale(1.12);
  box-shadow:
    0 12px 35px rgba(255,215,0,0.9),
    inset 0 2px 10px rgba(255,255,255,0.8);
}
.card{
  background:#111;
  border-radius:20px;
  border:1px solid rgba(255,215,0,0.15);
  box-shadow:0 15px 50px rgba(0,0,0,0.7);
}


/* RESULT */
#result{
  margin-top:25px;
  font-size:24px;
  font-weight:bold;
  animation: glow 1s infinite alternate;
}

@keyframes glow{
  from{ text-shadow:0 0 5px lime; }
  to{ text-shadow:0 0 20px rgb(0, 255, 64); }
}

/* ğŸ¬ AUTO SLIDER */
.slider{
  width:90%;
  max-width:600px;
  height:260px;
  margin:60px auto;
  overflow:hidden;
  border-radius:20px;
  box-shadow:0 0 35px rgb(0, 0, 0);
}

.slides{
  display:flex;
  width:300%;
  animation: slide 20s infinite;
}

.slides img{
  width:100%;
  height:260px;
  object-fit:contain;
  background:#000;
}

@keyframes slide{
  0%   { transform:translateX(0); }
  33%  { transform:translateX(-100%); }
  66%  { transform:translateX(-200%); }
  100% { transform:translateX(0); }
}

/* MUSIC BUTTON */
.music-btn{
  position:fixed;
  bottom:25px;
  right:25px;
  padding:12px 20px;
  border:none;
  border-radius:30px;
  font-size:14px;
  font-weight:bold;
  cursor:pointer;
  background:linear-gradient(45deg,#ffd700,#ff9900);
  color:black;
  box-shadow:0 0 15px #ffd700;
  transition:0.3s;
  z-index:999;
}

.music-btn:hover{
  transform:scale(1.08);
  box-shadow:0 0 25px #ffd700;
}

.music-off{
  background:linear-gradient(45deg,#555,#222);
  color:white;
  box-shadow:0 0 15px #999;
}
@media (max-width:600px){
  button{
    width:85%;
    font-size:20px;
    padding:18px 0;
  }
}

</style>
</head>
<body>

<script>
/* ğŸ” Protect Page */
const token = localStorage.getItem("playerToken");
if(!token){
  window.location.href="/player-login.html";
}
</script>

<!-- TOP BAR -->
<div class="topbar">

  <!-- LEFT -->
  <div class="nav-left">
    <div class="menu-btn" onclick="toggleMenu()">â˜°</div>
  </div>

  <!-- CENTER LOGO -->
  <div class="nav-center">
    ğŸ‰ <span>Player Dashboard</span>
  </div>

  <!-- RIGHT USER AREA -->
  <div class="nav-right">
    <div class="user-box">
      ğŸ‘¤ <span id="username"></span>
    </div>

    <div class="spin-box">
      ğŸ¯ <span id="topSpins">0</span>
    </div>
  </div>

</div>

<!-- SIDEBAR -->
<div class="sidebar" id="sidebar">
  <a href="#" onclick="showGame(); closeMenu()">ğŸ¡ Spin Game</a>
  <a href="#" onclick="showHistory(); closeMenu()">ğŸ“œ My History</a>
  <a href="#" onclick="logout()">ğŸšª Logout</a>
</div>


<!-- CONTENT -->
<div class="content">

  <!-- game -->
  <div id="gameSection">
    <h2>Spin & Win</h2>

    <!-- wheel -->
    <div id="wheelContainer">
      <div id="wheelWrapper">
        <div class="pointer"></div>
        <canvas id="wheelCanvas" width="420" height="420"></canvas>
      </div>
    </div>
     
    <button onclick="spinWheel()">ğŸ¡ SPIN</button>
    <div id="result"></div>
  </div>

  <!-- history -->
  <div id="historySection" style="display:none;">
    <h2>My Spin History</h2>
    <div id="historyData">Loading...</div>
  </div>

  <!-- slider -->
  <div class="slider">
    <div class="slides">
      <img src="img/poster1.jpg" alt="Poster 1">
      <img src="img/poster2.jpg" alt="Poster 2">
      <img src="img/poster3.jpg" alt="Poster 3">
    </div>
  </div>

</div>

<!-- Music -->
<audio id="casinoMusic" loop autoplay muted>
  <source src="/music.mp3" type="audio/mpeg">
</audio>

<button id="musicToggle" class="music-btn">
  ğŸ”Š MUSIC ON
</button>

<script>
// ----- parse token to get username -----
function parseJwt(token){
  return JSON.parse(atob(token.split('.')[1]));
}
const decoded = parseJwt(token);
document.getElementById("username").innerText = decoded.username;

// ----- MENU / LOGOUT / SECTION -----
function toggleMenu(){
  const sidebar = document.getElementById("sidebar");
  sidebar.classList.toggle("active");
}

function logout(){
  // keep musicState if you want, but remove token only
  localStorage.removeItem("playerToken");
  window.location.href="/player-login.html";
}

function showGame(){
  document.getElementById("gameSection").style.display="block";
  document.getElementById("historySection").style.display="none";
}

function showHistory(){
  document.getElementById("gameSection").style.display="none";
  document.getElementById("historySection").style.display="block";
  loadHistory();
}
function closeMenu(){
  document.getElementById("sidebar").classList.remove("active");
}

// Close sidebar when clicking outside
document.addEventListener("click", function(e){
  const sidebar = document.getElementById("sidebar");
  const menuBtn = document.querySelector(".menu-btn");

  if(
    sidebar.classList.contains("active") &&
    !sidebar.contains(e.target) &&
    !menuBtn.contains(e.target)
  ){
    sidebar.classList.remove("active");
  }
});
/* ------------------------------------ */
/* --------- Draw wheel style ---------- */
/* ------------------------------------ */

const canvas = document.getElementById("wheelCanvas");
const ctx = canvas.getContext("2d");

/* ğŸ”¥ áŠá¶á€áŸ‹ prizes á›á¾á‚áŸá”áŸ†á•á»á */
const prizes = [
  { value: 0,  label: "0$" },
  { value: 5,  label: "5$" },
  { value: 10, label: "10$" },
  { value: 20, label: "20$" },
  { value: 30, label: "30$" },
  { value: 50, label: "50$" },
  { value: 100,label: "100$" },
  { value: 200,label: "200$" }
];

let currentRotation = 0;
let spinning = false;

/* á”á“áŸ’á‘á¶á”áŸ‹á˜á€á‘á¾á”á˜á¶á“ function drawWheel */
function drawWheel(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const arc = 2*Math.PI/prizes.length;
  ctx.font = "bold 14px Segoe UI";
  ctx.textAlign = "right";

  for(let i=0;i<prizes.length;i++){
    ctx.beginPath();
    ctx.moveTo(canvas.width/2,canvas.height/2);

    ctx.fillStyle = (i % 2 === 0) ? "#ffd700" : "#1a1a1a";

    ctx.arc(
      canvas.width/2,
      canvas.height/2,
      canvas.width/2,
      i * arc - Math.PI/2,
      (i + 1) * arc - Math.PI/2
    );

    ctx.fill();

    ctx.save();
    ctx.translate(canvas.width/2,canvas.height/2);
    ctx.rotate(i*arc + arc/2 - Math.PI/2);
    ctx.fillStyle = (i % 2 === 0) ? "#000" : "#ffd700";
    ctx.fillText(prizes[i].label,canvas.width/2 - 20,10);
    ctx.restore();
  }
}

drawWheel();


/* ------------------------------------ */
/* --------- Spin logic -------------- */
/* ------------------------------------ */

async function spinWheel(){
  if(spinning) return;

  const res = await fetch("/spin",{
    method:"POST",
    headers:{ "Authorization":"Bearer "+token }
  });

  const data = await res.json();

  console.log("Server prize:", data.prize, typeof data.prize); // debug

  if(!res.ok){
    alert(data.message);
    return;
  }

  spinning = true;

  // á€áŸ†áááŸ‹ index
  let index = -1;

  // á”áŸ’ášáŸá·á“á”á¾ prize á‡á¶ number
  if(typeof data.prize === "number"){
    index = prizes.findIndex(p => p.value === data.prize);
  } else {
    // á”áŸ’ášáŸá·á“á”á¾ prize á‡á¶ string
    // á¢á¶á…á˜á¶á“ "50$" á¬â€‹ á¬ "Try Again"
    // á‡á¶á˜á½á™ label á¬ value
    index = prizes.findIndex(p => p.label === data.prize);
    // á”á¾ááŸ’ášá¼áœááŸ‚áŠá€ $ á²áŸ’á™á”áŸ’ášáŸ€á”á”áŸ’ášáŠá¶á”áŸ‹
    if(index < 0){
      // try to parse number from string
      const num = parseInt(data.prize.replace(/[^0-9]/g, ""));
      if(!isNaN(num)){
        index = prizes.findIndex(p => p.value === num);
      }
    }
  }

  if(index < 0){
    // fallback
    index = 0;
  }

const sliceDeg = 360 / prizes.length;

// á‚áá“á¶ degree á…á»á„á€áŸ’ášáŸ„á™ááŸ’ášá¹á˜ááŸ’ášá¼áœ
const finalDeg = 360 - (index * sliceDeg) - sliceDeg / 2;

// á”á„áŸ’áœá·á› 5 á‡á»áŸ† á á¾á™á”á‰áŸ’áˆá”áŸ‹ááŸ’ášá¹á˜ slice
const totalRotation = 360 * 5 + finalDeg;

// RESET rotation á˜á»á“
canvas.style.transition = "none";
canvas.style.transform = "rotate(0deg)";

// á”á„áŸ’ááŸ† browser reflow
void canvas.offsetWidth;

// á”á„áŸ’áœá·á›ááŸ’á˜á¸
canvas.style.transition = "transform 6s cubic-bezier(.15,.85,.25,1)"
canvas.style.transform = `rotate(${totalRotation}deg)`;


  setTimeout(()=>{
    document.getElementById("result").innerText =
      "ğŸ‰  á¢áŸ’á“á€áˆáŸ’á“áŸ‡: "+data.prize+
      " | Remaining Spins: "+data.spinsLeft;

    document.getElementById("topSpins").innerText = data.spinsLeft;
    spinning = false;
  },6000);
}

/* ------------------------------------ */
/* --------- History ------------------ */
/* ------------------------------------ */
async function loadHistory(){
  const res = await fetch("/api/history",{
    headers:{ "Authorization":"Bearer "+token }
  });

  const data = await res.json();

  if(!data.length){
    document.getElementById("historyData").innerHTML="No spins yet.";
    return;
  }

  let html="";
  data.forEach(d=>{
    html += `
      <div style="padding:10px;border-bottom:1px solid #444;">
        ğŸ $${d.prize}<br>
        ğŸ“… ${new Date(d.createdAt).toLocaleString()}
      </div>
    `;
  });
  document.getElementById("historyData").innerHTML=html;
}

/* ------------------------------------ */
/* --------- Load balance on start ---- */
/* ------------------------------------ */
async function loadMySpin(){
  const res = await fetch("/api/my-spin",{
    headers:{ "Authorization":"Bearer "+token }
  });
  const data = await res.json();

  document.getElementById("topSpins").innerText = data.spinsLeft;
}
loadMySpin();

/* ------------------------------------ */
/* --------- Music toggle ------------ */
/* ------------------------------------ */
document.addEventListener("DOMContentLoaded", function () {
  const musicBtn = document.getElementById("musicToggle");
  const casinoMusic = document.getElementById("casinoMusic");

  // Read from localStorage (data saved across sessions).  
  // localStorage persists across browser sessions according to MDN docs. :contentReference[oaicite:0]{index=0}
  let state = localStorage.getItem("musicState") || "on";

  function updateMusic(){
    if(state === "on"){
      casinoMusic.muted = false;
      musicBtn.innerText = "ğŸ”Š MUSIC ON";
      casinoMusic.play().catch(()=>{});
    } else {
      casinoMusic.muted = true;
      musicBtn.innerText = "ğŸ”‡ MUSIC OFF";
    }
  }

  updateMusic();

  musicBtn.addEventListener("click", ()=>{
    state = (state === "on") ? "off" : "on";
    localStorage.setItem("musicState", state);
    updateMusic();
  });
});
</script>

</body>
</html>
