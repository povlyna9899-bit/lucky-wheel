<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard Pro</title>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:Segoe UI,sans-serif}
body{background:#f1f5f9;transition:.3s;}
.dark{background:#0f172a;color:white;}
.layout{display:flex;min-height:100vh}

/* Sidebar */
.sidebar{
  width:240px;
  background:#1e293b;
  color:white;
  padding:25px;
}
.sidebar h2{margin-bottom:20px}
.sidebar button{
  width:100%;
  padding:10px;
  margin-top:10px;
  border:none;
  border-radius:6px;
  cursor:pointer;
}
.logout{background:#ef4444;color:white}
.toggle{background:#2563eb;color:white}

/* Main */
.main{flex:1;padding:40px}
.card{
  background:white;
  padding:20px;
  border-radius:10px;
  box-shadow:0 5px 15px rgba(0,0,0,.08);
  margin-bottom:25px;
}
.dark .card{background:#1e293b;color:white;}

input{
  width:100%;
  padding:8px;
  margin-bottom:10px;
  border-radius:6px;
  border:1px solid #ccc;
}

.btn{
  padding:6px 12px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  font-size:13px;
  margin:2px;
}
.primary{background:#2563eb;color:white}
.danger{background:#ef4444;color:white}
.edit{background:#f59e0b;color:white}
.history{background:#16a34a;color:white}

table{width:100%;border-collapse:collapse;}
th,td{padding:10px;border-bottom:1px solid #eee;text-align:left;}
.dark th,.dark td{border-color:#334155;}

.modal{
  position:fixed;
  top:0;left:0;
  width:100%;height:100%;
  background:rgba(0,0,0,.5);
  display:none;
  justify-content:center;
  align-items:center;
}
.modal-content{
  background:white;
  padding:20px;
  border-radius:10px;
  width:300px;
}
.dark .modal-content{background:#1e293b;}
</style>
</head>

<body>

<div class="layout">

<div class="sidebar">
  <h2>Admin Panel</h2>

  <button onclick="toggleWinning()" 
    style="background:#f39c12;color:white;border:none;padding:10px;width:100%;border-radius:6px;margin-bottom:10px;">
    üéØ Winning Probability
  </button>

  <!-- ‚úÖ WINNING PANEL INSIDE SIDEBAR -->
  <div id="winningPanel" style="display:none; margin-bottom:15px;">

    <h4 style="color:white;">Winning Probability Control</h4>

    <div id="probabilityContainer"></div>

    <p style="color:white;">
      Total: <span id="totalPercent">0</span>%
    </p>

    <button onclick="saveProbability()" 
      style="background:#28a745;color:white;border:none;padding:8px;width:100%;border-radius:6px;">
      Save
    </button>

  </div>

  <button class="toggle" onclick="toggleDark()">Toggle Dark</button>
  <button class="logout" onclick="logout()">Logout</button>
</div>

<div class="main">

<h1>Dashboard</h1>
<p>Total Players: <b id="totalCount">0</b></p>

<div class="card">
  <h3>Create Player</h3>
  <input type="text" id="username" placeholder="Username">
  <input type="password" id="password" placeholder="Password">
  <button class="btn primary" onclick="createPlayer()">Create</button>
</div>

<div class="card">
  <h3>Player List</h3>
  <input type="text" id="search" placeholder="Search..." onkeyup="filterPlayers()">

  <table>
    <thead>
      <tr>
        <th>Username</th>
        <th>Spins</th>
        <th>Balance</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="playerTable"></tbody>
  </table>
</div>

<div class="card">
  <h3>User Spin History</h3>

  <p>Total Reward: <b id="totalReward">0</b></p>

  <div style="margin-bottom:10px;">
    <input type="date" id="startDate">
    <input type="date" id="endDate">
    <button class="btn primary" onclick="filterHistory()">Filter</button>
    <button class="btn" onclick="resetFilter()">Reset</button>
    <br><br>
    <button class="btn history" onclick="filterToday()">Today</button>
    <button class="btn history" onclick="filterWeek()">This Week</button>
    <button class="btn history" onclick="filterMonth()">This Month</button>
  </div>

  <div id="historyBox"></div>
</div>

<!-- Edit Modal -->
<div class="modal" id="editModal">
  <div class="modal-content">
    <h3>Edit Player</h3>
    <input type="text" id="editUsername">
    <input type="password" id="editPassword" placeholder="New Password">
    <button class="btn primary" onclick="updatePlayer()">Save</button>
  </div>
</div>

<script>

const token = localStorage.getItem("adminToken");
if(!token) window.location.href="/admin-login.html";

let playersData = [];
let editingId = "";
let currentHistory = [];

/* CREATE PLAYER */
async function createPlayer(){
  const username = document.getElementById("username").value;
  const password = document.getElementById("password").value;

  const res = await fetch("/create-player",{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "Authorization":"Bearer "+token
    },
    body:JSON.stringify({username,password})
  });

  const data = await res.json();
  if(data.success) loadPlayers();
  else alert(data.message);
}

/* LOAD PLAYERS */
async function loadPlayers(){
  const res = await fetch("/players",{
    headers:{ "Authorization":"Bearer "+token }
  });

  if(res.status===401 || res.status===403){
    alert("Session expired");
    logout();
    return;
  }

  const data = await res.json();
  playersData = data;
  renderTable(data);
}
/* ================= PROBABILITY SYSTEM ================= */

async function loadProbability() {
  try {
    const res = await fetch("/api/admin/prize-settings", {
      headers: {
        Authorization: "Bearer " + token
      }
    });

    const result = await res.json();
    console.log("API Result:", result);

    const prizeList = result.prizes || result.data || result;

    if (!Array.isArray(prizeList)) {
      console.log("Prize list not array");
      return;
    }

    const container = document.getElementById("probabilityContainer");
    container.innerHTML = "";

    let total = 0;

    prizeList.forEach(p => {
      const weight = p.weight ?? p.percent ?? 0;
      total += weight;

      container.innerHTML += `
        <div style="margin-bottom:10px">
          ${p.value}$ :
          <input 
            type="number"
            class="prob-input"
            data-value="${p.value}"
            value="${weight}"
            onchange="calculateTotal()">
        </div>
      `;
    });

    document.getElementById("totalPercent").innerText = total;
    calculateTotal();

  } catch (err) {
    console.log("Load error:", err);
  }
}

function calculateTotal(){
  const inputs = document.querySelectorAll(".prob-input");
  let total = 0;

  inputs.forEach(i=>{
    total += Number(i.value) || 0;
  });

  const totalEl = document.getElementById("totalPercent");
  totalEl.innerText = total;

  if(total !== 100){
    totalEl.style.color = "red";
  }else{
    totalEl.style.color = "green";
  }
}

async function saveProbability() {
  const inputs = document.querySelectorAll(".prob-input");

  let data = [];
  let total = 0;

  inputs.forEach(input => {
    const value = Number(input.dataset.value);
    const weight = Number(input.value) || 0;

    total += weight;
    data.push({ value, weight });
  });

  if (total !== 100) {
    alert("Total must equal 100%");
    return;
  }

  const res = await fetch("/api/admin/prize-settings", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + token   // ‚úÖ ·ûî·üí·ûö·ûæ token ·ûè·üÇ·ûò·ûΩ·ûô
    },
    body: JSON.stringify(data)
  });

  if(res.ok){
    alert("Saved successfully");
  }else{
    alert("Error saving data");
  }
}

/* SEARCH */
function filterPlayers(){
  const keyword=document.getElementById("search").value.toLowerCase();
  const filtered=playersData.filter(p=>
    p.username.toLowerCase().includes(keyword)
  );
  renderTable(filtered);
}

/* RENDER TABLE */
function renderTable(data){
  const table=document.getElementById("playerTable");
  table.innerHTML="";
  document.getElementById("totalCount").innerText=data.length;

  data.forEach(p=>{
    const row=document.createElement("tr");
    row.innerHTML=`
      <td>${p.username}</td>
      <td>${p.spinsLeft ?? 0}</td>
      <td>$${p.balance ?? 0}</td>
      <td>
        <button class="btn history" onclick="viewHistory('${p._id}')">History</button>
        <button class="btn edit" onclick="openEdit('${p._id}','${p.username}')">Edit</button>
        <button class="btn danger" onclick="deletePlayer('${p._id}')">Delete</button>
        <button class="btn primary" onclick="setSpin('${p._id}')">Set Spin</button>
      </td>
    `;
    table.appendChild(row);
  });
}

/* VIEW HISTORY */
async function viewHistory(userId){
  const res = await fetch("/api/admin/user-history/"+userId,{
    headers:{ "Authorization":"Bearer "+token }
  });

  const data = await res.json();
  currentHistory = data;
  renderHistory(data);
}

/* RENDER HISTORY */
function renderHistory(data){
  const box=document.getElementById("historyBox");
  box.innerHTML="";
  let total=0;

  if(!data.length){
    box.innerHTML="No spin history";
    document.getElementById("totalReward").innerText=0;
    return;
  }

  data.forEach(item=>{
    total+=item.prize;
    box.innerHTML+=`
      <div style="padding:8px;border-bottom:1px solid #ddd;">
        üéÅ $${item.prize} |
        üìÖ ${new Date(item.createdAt).toLocaleString()}
      </div>
    `;
  });

  document.getElementById("totalReward").innerText=total;
}

/* FILTER */
function filterHistory(){
  const start=document.getElementById("startDate").value;
  const end=document.getElementById("endDate").value;
  if(!start||!end)return;

  const filtered=currentHistory.filter(item=>{
    const d=new Date(item.createdAt).toISOString().split("T")[0];
    return d>=start && d<=end;
  });

  renderHistory(filtered);
}

function resetFilter(){
  document.getElementById("startDate").value="";
  document.getElementById("endDate").value="";
  renderHistory(currentHistory);
}

/* QUICK FILTERS */
function formatDate(date){
  return date.toISOString().split("T")[0];
}

function filterToday(){
  const today=new Date();
  document.getElementById("startDate").value=formatDate(today);
  document.getElementById("endDate").value=formatDate(today);
  filterHistory();
}

function filterWeek(){
  const today=new Date();
  const first=new Date(today);
  first.setDate(today.getDate()-today.getDay());
  const last=new Date(first);
  last.setDate(first.getDate()+6);
  document.getElementById("startDate").value=formatDate(first);
  document.getElementById("endDate").value=formatDate(last);
  filterHistory();
}

function filterMonth(){
  const now=new Date();
  const first=new Date(now.getFullYear(),now.getMonth(),1);
  const last=new Date(now.getFullYear(),now.getMonth()+1,0);
  document.getElementById("startDate").value=formatDate(first);
  document.getElementById("endDate").value=formatDate(last);
  filterHistory();
}

/* DELETE */
async function deletePlayer(id){
  if(!confirm("Delete this player?")) return;
  await fetch("/delete/"+id,{
    method:"DELETE",
    headers:{ "Authorization":"Bearer "+token }
  });
  loadPlayers();
}

/* EDIT */
function openEdit(id,username){
  editingId=id;
  document.getElementById("editUsername").value=username;
  document.getElementById("editPassword").value="";
  document.getElementById("editModal").style.display="flex";
}

async function updatePlayer(){
  const username=document.getElementById("editUsername").value;
  const password=document.getElementById("editPassword").value;

  await fetch("/edit-player/"+editingId,{
    method:"PUT",
    headers:{
      "Content-Type":"application/json",
      "Authorization":"Bearer "+token
    },
    body:JSON.stringify({username,password})
  });

  document.getElementById("editModal").style.display="none";
  loadPlayers();
}

/* SET SPIN */
function setSpin(id){
  const spins=prompt("Enter spin amount:");
  if(!spins) return;

  fetch("/set-spin/"+id,{
    method:"PUT",
    headers:{
      "Content-Type":"application/json",
      "Authorization":"Bearer "+token
    },
    body:JSON.stringify({spins:Number(spins)})
  }).then(()=>loadPlayers());
}

/* DARK MODE */
function toggleDark(){
  document.body.classList.toggle("dark");
}

/* LOGOUT */
function logout(){
  localStorage.removeItem("adminToken");
  window.location.href="/admin-login.html";
}

loadPlayers();
loadProbability();   // ·ûî·ûì·üí·ûê·üÇ·ûò·ûî·ûì·üí·ûë·û∂·ûè·üã·ûì·üÅ·üá
function toggleWinning() {
  const panel = document.getElementById("winningPanel");

  if (panel.style.display === "none") {
    panel.style.display = "block";
  } else {
    panel.style.display = "none";
  }
}

</script>

</body>
</html>